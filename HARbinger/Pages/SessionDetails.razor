@page "/session-details"

@using System.Text.Json;
@using HARbinger.Models;
@using HARbinger.Services;

@inject ISnackbar Snackbar

<style>
    .mud-table-cell-custom-group {
        font-weight: 500;
    }

    .mud-table-cell-custom-group-footer {
        padding-bottom: 50px;
        text-align: right;
    }
</style>
<MudPaper Elevation="25">
    <MudToolBar>
        <MudButton 
            OnClick="Back"
            Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.NavigateBefore" Color="Color.Default">Back</MudButton>
        <MudSpacer />
        <MudText>Select Content To Export</MudText>
        <MudSpacer />
        <MudButton 
            OnClick="Next"
            Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.NavigateNext" Color="Color.Primary">Next</MudButton>
    </MudToolBar>
</MudPaper>
<MudPaper Class="d-flex justify-center flex-grow1 gap-4">
    <MudTable Hover="true" Breakpoint="Breakpoint.Sm" Height="500px" FixedHeader="true"
              Items="@Entries"
              Virtualize="@true"
              GroupBy="@_groupDefinition"
              GroupHeaderStyle="background-color:var(--mud-palette-background-grey)"
              GroupFooterClass="mb-4"
              Dense="true"
              MultiSelection="_multiSelect">
        <ColGroup>
            @if (_multiSelect)
            {
                <col style="width: 60px;" />
            }
            @if (_groupDefinition.Expandable)
            {
                <col style="width: 60px;" />
            }
            <col />
        </ColGroup>
        <HeaderContent>
            <MudTh>URL</MudTh>
            <MudTh>Operation Name</MudTh>
        </HeaderContent>
        <GroupHeaderTemplate>
            <MudTh Class="mud-table-cell-custom-group" colspan="5">@($"{context.GroupName}: {context.Key}")</MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="URL">@context.request.url</MudTd>
                <MudTd DataLabel="OperationName">@context.request?.postData?.text?.Take(50)</MudTd>
            </RowTemplate>
        </MudTable>
</MudPaper>

    @inject NavigationManager NavigationManager
    @code {
        private bool _multiSelect = true;
        private TableGroupDefinition<Entries> _groupDefinition = new()
            {
                GroupName = "Query",
                Indentation = false,
                Expandable = false,
                Selector = (e) => e.request.url
            };

        private IEnumerable<Entries> Entries = HarFileService.HarData?.log?.entries;

        private void Back()
        {
            NavigationManager.NavigateTo("/import-file");
        }

        private void Next()
        {
            NavigationManager.NavigateTo("/repo-settings");
        }
    }
